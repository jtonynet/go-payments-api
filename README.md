<a id="header"></a>

<!-- 
    Logo image generated by Bing IA: https://www.bing.com/images/create/
    Prompt: gopher azul, simbolo da linguagem golang com um bone laranja, trabalhando como caixa de supermercado com algumas maquinhas de cartão de credito e cartões em cima da mesa, estilo cartoon, historia em quadrinhos, fundo branco chapado para facilitar remoção
-->
<div align="center">
<a href="#header">
    <img src="./docs/assets/images/layout/header.png" alt="gopher azul, simbolo da linguagem golang com um bone laranja, trabalhando como caixa de supermercado com algumas maquinhas de cartão de credito e cartões em cima da mesa, estilo cartoon, historia em quadrinhos" />
</a>
</div>

<!-- 
    icons by:
    https://devicon.dev/
    https://simpleicons.org/
-->
[<img src="./docs/assets/images/icons/go.svg" width="25px" height="25px" alt="Go Logo" title="Go">](https://go.dev/) [<img src="./docs/assets/images/icons/gin.svg" width="25px" height="25px" alt="Gin Logo" title="Gin">](https://gin-gonic.com/) [<img src="./docs/assets/images/icons/postgresql.svg" width="25px" height="25px" alt="PostgreSql Logo" title="PostgreSql">](https://www.postgresql.org/) [<img src="./docs/assets/images/icons/redis.svg" width="25px" height="25px" alt="Redis Logo" title="Redis">](https://redis.com/) [<img src="./docs/assets/images/icons/grpc.svg" width="45px" alt="gRPC Logo" title="gRPC">](https://grpc.io/) [<img src="./docs/assets/images/icons/docker.svg" width="25px" height="25px" alt="Docker Logo" title="Docker">](https://www.docker.com/) [<img src="./docs/assets/images/icons/ubuntu.svg" width="25px" height="25px Logo" title="Ubuntu" alt="Ubuntu" />](https://ubuntu.com/) [<img src="./docs/assets/images/icons/dotenv.svg" width="25px" height="25px" alt="Viper DotEnv Logo" title="Viper DotEnv">](https://github.com/spf13/viper) [<img src="./docs/assets/images/icons/github.svg" width="25px" height="25px" alt="GitHub Logo" title="GitHub">](https://github.com/jtonynet) [<img src="./docs/assets/images/icons/visualstudiocode.svg" width="25px" height="25px" alt="VsCode Logo" title="VsCode">](https://code.visualstudio.com/) [<img src="./docs/assets/images/icons/swagger.svg" width="25px" height="25px" alt="Swagger Logo" title="Swagger">](https://swagger.io/) [<img src="./docs/assets/images/icons/miro.svg" width="25px" height="25px" alt="Miro Logo" title="Miro">](https://https://miro.com/) [<img src="./docs/assets/images/icons/mermaidjs.svg" width="25px" height="25px" alt="MermaidJS Logo" title="MermaidJS">](https://mermaid.js.org/) [<img src="./docs/assets/images/icons/githubactions.svg" width="25px" height="25px" alt="GithubActions Logo" title="GithubActions">](https://docs.github.com/en/actions) [<img src="./docs/assets/images/icons/gatling.svg" width="35px" height="35px" alt="Gatling Logo" title="Gatling">](https://gatling.com/) [<img src="./docs/assets/images/icons/prometheus.svg" width="25px" height="25px" alt="Prometheus Logo" title="Prometheus">](https://prometheus.io/) [<img src="./docs/assets/images/icons/grafana.svg" width="25px" height="25px" alt="Grafana Logo" title="Grafana">](https://grafana.com/)  [<img src="./docs/assets/images/icons/grafana_loki.png" width="30px" height="30px" alt="Grafana Loki Logo" title="Grafana Loki">](https://grafana.com/oss/loki/) 

<!--
[<img src="./docs/assets/images/icons/opentelemetry.svg" width="25px" height="25px" alt="OpenTelemetry Logo" title="OpenTelemetry">](https://opentelemetry.io/) [<img src="./docs/assets/images/icons/jaeger.svg" width="25px" height="25px" alt="Jaeger Logo" title="Jaeger">](https://www.jaegertracing.io/) 

[<img src="./docs/assets/images/icons/k6.svg" width="25px" height="25px" alt="K6 Logo" title="K6">](https://k6.io/) 
--> 

<!-- 
[<img src="./docs/assets/images/icons/nginx.svg" width="25px" height="25px" alt="nginx Logo" title="nginx">](https://nginx.org/en/) [<img src="./docs/assets/images/icons/rabbitmq.svg" width="25px" height="25px" alt="RabbitMQ Logo" title="RabbitMQ">](https://rabbitmq.com/)
-->

[![Badge Status](https://img.shields.io/badge/STATUS-REABERTO-green)](#header) [![Github Project](https://img.shields.io/badge/PROJECT%20VIEW-KANBAN-green?logo=github&logoColor=white)](https://github.com/users/jtonynet/projects/7/views/1)  [![Badge GitHubActions](https://github.com/jtonynet/go-payments-api/actions/workflows/main.yml/badge.svg?branch=main)](https://github.com/jtonynet/go-payments-api/actions) [![Go Version](https://img.shields.io/badge/GO-1.23.2-blue?logo=go&logoColor=white)](https://go.dev/)


## 🕸️ Redes

[![linkedin](https://img.shields.io/badge/Linkedin-0A66C2?style=for-the-badge&logo=linkedin&logoColor=white)](https://www.linkedin.com/in/jos%C3%A9-r-99896a39/) [![dev.to](https://img.shields.io/badge/dev.to-0A0A0A?style=for-the-badge&logo=devdotto&logoColor=white)](https://dev.to/learningenuity) [![gmail](https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&logo=gmail&logoColor=white)](mailto:learningenuity@gmail.com)

---

<br/>

## 📁 O Projeto

<a id="index"></a>
### ⤴️ Índice

__[Go Payments API](#header)__<br/>
  1.  ⤴️ [Índice](#index)
  2.  📖 [Sobre](#about)
  3.  💻 [Rodando o Projeto](#run)
      - 🌐 [Ambiente](#environment)
      - 🐋 [Containerizado](#run-containerized)
      - 🏠 [Local](#run-locally)
  4.  📰 [Documentação da API](#api-docs)
  5.  ✅ [Testes Unitários & Integração](#tests)
      - 🐋 [Containerizado](#test-containerized)
      - 🏠 [Local](#test-locally)
      - ⚙️  [Executando Testes](#test-auto)
  6.  🚚 [Testes Carga & Performance](#test-load)
  7.  🕵️ [Observabilidade WIP](#observability)
  8.  🧑‍🔧 [Validação Manual](#test-manual)
  9.  📊 [Diagramas](#diagrams)
      - 📈 [ER](#diagrams-erchart)
      - 📈 [Fluxo](#diagrams-flowchart) 
  10. 🅻 [Questão Aberta L4](#open-question)
  11.  🧠 [ADR - Architecture Decision Records](#adr)
  12.  🔢 [Versões](#versions)
  13.  🧰 [Ferramentas](#tools)
  14.  👏 [Boas Práticas](#best-practices)
  15.  🤖 [Uso de IA](#ia)
  16.  🏁 [Conclusão](#conclusion)

---

<br/>

<a id="about"></a>
### 📖 Sobre

__Resumo:__

> 
> Desafio de `Payment Authorizer` de benefícios em `Hexagonal Architecture` com `100ms SLA` por request e controle de concorrência com baixa possibilidade de colisão. 
> Construído com `Gin` e `Gorm`, protocolo `gRPC` entre o serviço `REST` `HTTP` ("aberto" ao mundo, o ponto de entrada) e o serviço `Processor` ("fechado" ao mundo, o processador de pagamentos) por segurança.
>
> __Principais Tecnologias e abordagens:__
> - `Hexagonal Architecture`
> - `TDD`, `DDD`, `SOLID`, `ADRs`
> - `REST` `HTTP` e `gRPC` entre `Microsservices`
> - `Dockerized` Solução com uso de containers
> - `PostgreSQL` modelado inspirado em `Event Sourcing` garantindo `Consistency`
> -  `Concurrent Programming`
> - `Redis` para `Pessimistic Memory Lock`
> - `Redis Keyspace Notification` como `Pub/Sub` para notificar `Unlocks` <br/>(`Robust Queues` foram desconsideradas devido `Additional Latency`)
> - `CI` com `GitHub Actions` 
> - `Diagram as code` com `Mermaid.js` e `Miro`
> - `Performance/Load Test Dockerized` com `Gatling`
> - `Observability` (WIP)
>   - `Prometheus` e `Grafana` para `RED Metrics`
>   - `Grafana Loki` e `Promtail` para `Logs`

<br/>

Após concluir os requisitos obrigatórios (`L1`, `L2`, `L3`) no prazo, retomei o desafio, focando melhorias do diagrama `Miro` criado em conjunto a equipe proponente. Implementei o requisito `L4` como aprimoramento técnico sugerido no diagrama e na `ADR` [0003: gRPC e Redis Keyspace Notification reduzindo Latência e evitando Concorrência](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-processor-para-reduzir-latencia-e-evitar-concorrencia.md).


<!-- 
    diagram by:
    https://miro.com
-->
<div align="center">
    <img src="./docs/assets/images/screen_captures/miro/architectureV3_segregation_services_grpc.png"> 
    <br/>
    <i>*Para acompanhar a evolução do projeto com seus respectivos diagramas, acesse o seguinte <a href="./docs/architecture/evolution.md">documento</a></i>
</div>



<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

__Texto Original:__

Acompanhe as tarefas pelo __[Kanban](https://github.com/users/jtonynet/projects/7/views/1)__

Este repositório foi criado com a intenção de propor uma possível solução para o seguinte desafio:

> <br/>
> 
> 👨‍💻 __Desafio Técnico:__
>
> Além de avaliar a correção da sua solução, temos interesse em ver como você modela o domínio, organiza seu código e implementa seus testes. 
>
>
> __Linguagem e bibliotecas:__
> 
> Na *********, usamos Scala e Kotlin no nosso dia a dia (e demonstrar experiência em alguma delas é um grande diferencial). No entanto, você pode implementar sua solução utilizando sua linguagem favorita, dando preferência ao paradigma de programação funcional.
>
> __Como entregar a solução?__
> 
> Entregue a sua solução preferencialmente criando um repositório git (Github, Gitlab, etc).
>
> É muito importante escrever um arquivo README com as instruções para execução do projeto.
> 
> Agora, vamos guiá-lo através de alguns conceitos básicos.
> 
> <br/>
> 
> ---
> 
> <br/>
> 
> __Transaction__
>
> Uma versão simplificada de um transaction payload de cartão de crédito é o seguinte:
>
> ```json
> {
> 	"account": "123",
> 	"totalAmount": 100.00,
> 	"mcc": "5811",
> 	"merchant": "PADARIA DO ZE               SAO PAULO BR"
> }
> ```
>
>
> __Atributos__
>
> - **id** - Um identificador único para esta transação.
> - **accountId** - Um identificador para a conta.
> - **amount** - O valor a ser debitado de um saldo.
> - **merchant** - O nome do estabelecimento.
> - **mcc** - Um código numérico de 4 dígitos que classifica os estabelecimentos comerciais de acordo com o tipo de produto vendido ou serviço prestado.
>    
>    O `MCC` contém a classificação do estabelecimento. Baseado no seu valor, deve-se decidir qual o saldo será utilizado (na totalidade do valor da transação). Por simplicidade, vamos usar a seguinte regra:
>    
>    - Se o `mcc` for `"5411"` ou `"5412"`, deve-se utilizar o saldo de `FOOD`.
>    - Se o `mcc` for `"5811"` ou `"5812"`, deve-se utilizar o saldo de `MEAL`.
>    - Para quaisquer outros valores do `mcc`, deve-se utilizar o saldo de `CASH`.
>
> <br/>
> 
> ---
>
> <br/>
> 
> __Desafios (o que você deve fazer)__
> 
> Cada um dos desafios a seguir são etapas na criação de um autorizador completo. Seu autorizador deve ser um servidor HTTP que processe a transaction payload JSON usando as regras a seguir.
>
> As possíveis respostas são:
> - `{ "code": "00" }` se a transação é **aprovada**
> - `{ "code": "51" }` se a transação é **rejeitada**, porque não tem saldo suficiente
> - `{ "code": "07" }` se acontecer qualquer outro problema que impeça a transação de ser processada
>
> __O HTTP Status Code é sempre `200`__
> 
>
><br/>
>
> 1. __L1. Autorizador simples__
>     - O __autorizador simples__ deve funcionar da seguinte forma:
>       -  Recebe a transação
>       -  Usa **apenas** a MCC para mapear a transação para uma categoria de benefícios
>       -  Aprova ou rejeita a transação
>       -  Caso a transação seja aprovada, o saldo da categoria mapeada deverá ser diminuído em __totalAmount__.
>
> 2. __L2. Autorizador com fallback__
>     - Para despesas não relacionadas a benefícios, criamos outra categoria, chamada __CASH__. O autorizador com fallback deve funcionar como o autorizador simples, com a seguinte diferença:
>       - Se a MCC não puder ser mapeado para uma categoria de benefícios ou se o saldo da categoria fornecida não for suficiente para pagar a transação inteira, verifica o saldo de **CASH** e, se for suficiente, debita esse saldo.
>
> 3. __L3.Dependente do comerciante__
>     - As vezes, os MCCs estão incorretos e uma transação deve ser processada levando em consideração também os dados do comerciante. Crie um mecanismo para substituir MCCs com base no nome do comerciante. O nome do comerciante tem maior precedência sobre as MCCs.
>     - Exemplos:
>       - `UBER TRIP                   SAO PAULO BR`
>       - `UBER EATS                   SAO PAULO BR`
>       - `PAG*JoseDaSilva          RIO DE JANEI BR`
>       - `PICPAY*BILHETEUNICO           GOIANIA BR`
>   
> 4. __L4. Questão aberta__
>     - A seguir está uma questão aberta sobre um recurso importante de um autorizador completo (que você não precisa implementar, apenas discuta da maneira que achar adequada, como texto, diagramas, etc.).
>       - Transações simultâneas: dado que o mesmo cartão de crédito pode ser utilizado em diferentes serviços online, existe uma pequena mas existente probabilidade de ocorrerem duas transações ao mesmo tempo. O que você faria para garantir que apenas uma transação por conta fosse processada em um determinado momento? Esteja ciente do fato de que todas as solicitações de transação são síncronas e devem ser processadas rapidamente (menos de 100 ms), ou a transação atingirá o timeout.
> 
> <br/>
> 
> ---
>
> <br/>
> 
> _Para este teste, tente ao máximo implementar um sistema de autorização de transações considerando todos os desafios apresentados (L1 a L4) e conceitos básicos._
> 
> <br/>

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

<br/>

O desafio sugere `Scala`, `Kotlin` e o `paradigma funcional`, mas aceita outras linguagens e paradigmas. Realizei em [`Golang`](https://go.dev/), com arquitetura [`Hexagonal`](https://alistair.cockburn.us/hexagonal-architecture/), por maior experiência e familiaridade, além de ser mencionada na `job description` como parte do stack utilizado. Essa combinação atende bem aos requisitos do desafio.

Contudo, sou aberto a expandir minhas habilidades e disposto a aprender novas tecnologias e paradigmas conforme necessário.

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="run"></a>
### 💻 Rodando o Projeto

<a id="environment"></a>
#### 🌐 Ambiente

`Docker` e `Docker Compose` são necessários para rodar a aplicação de forma containerizada, e é fortemente recomendado utilizá-los para rodar o banco de dados localmente.

Crie uma copia do arquivo `./payments-api/.env.SAMPLE` e renomeie para `./payments-api/.env`.

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

<a id="run-containerized"></a>
#### 🐋 Containerizado 
_Recomendado_

Após a `.env` renomeada, rode os comandos `docker compose` (de acordo com sua versão do docker compose) no diretório raiz do projeto
```bash
# Construir a imagem
docker compose build

# Rodar o PostgreSQL e o Redis de Desenvolvimento
docker compose up postgres redis -d
```

<br/>

Caso seja a primeira execução do projeto, rode os comandos de `migrations` e `seeds` para dar carga inicial no banco de dados de desenvolvimento.
```bash
# Rodar Migrations de Desenvolvimento
docker compose up migrate

# Carga inicial no banco
docker compose exec postgres psql -U api_user -d payments_db -f /seeds/load_test_charge.up.sql
```

<br/>

Para então subir os serviços `REST` e `Processor`
```bash
# Rodar as APIs (Sugiro em terminais distintos para acompanhar debug logs)
docker compose up transaction-processor
docker compose up transaction-rest
```

<img src="./docs/assets/images/screen_captures/running.jpeg">

A API está pronta e a rota da [Documentação da API](#api-docs) (Swagger) estará disponível, assim como os [Testes](#tests) poderão ser executados.

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

<a id="run-locally"></a>

#### 🏠 Local
_Apenas se necessário_

Com o `Golang 1.23` instalado e após ter renomeado a copia de `.env.SAMPLE` para `.env`, serão necessárias outras alterações para que a aplicação funcione corretamente no seu `localhost`.

No arquivo `.env`, substitua os valores das variáveis de ambiente que contêm comentários no formato `local: valueA | containerized: valueB` pelos valores sugeridos na opção `local` (exceto o `DATABASE_PORT`).
```bash
DATABASE_HOST=localhost         ### local: localhost | conteinerized: test-postgres

PUBSUB_HOST=localhost           ### local: localhost | conteinerized: redis
IN_MEMORY_LOCK_HOST=localhost   ### local: localhost | conteinerized: redis
IN_MEMORY_CACHE_HOST=localhost  ### local: localhost | conteinerized: redis

GRPC_SERVER_HOST=localhost      ### local: localhost | conteinerized: transaction-processor
GRPC_CLIENT_HOST=localhost      ### local: localhost | conteinerized: transaction-processor
```

Após editar o arquivo, suba apenas o banco e o redis de dados com o comando:

```bash
# Rodar o PostgreSQL e o Redis de Desenvolvimento
docker compose up postgres redis -d
```

<br/>

Caso seja a primeira execução do projeto, rode os comandos de `migrations` e `seeds` para dar carga inicial no banco de dados de desenvolvimento.
```bash
# Rodar Migrations de Desenvolvimento
docker compose up migrate

# Carga inicial no banco
docker compose exec postgres psql -U api_user -d payments_db -f /seeds/load_test_charge.up.sql
```

<br/>

ou se conecte a database/redis válidos no arquivo `.env`, então no diretório `payments-api` execute os comandos:

```bash
# Instala Dependências
go mod download

# Rodar as APIs (Sugiro em terminais distintos para acompanhar debug logs)
go run cmd/processor/main.go
go run cmd/rest/main.go
```
 A API está pronta e a rota da [Documentação da API](#api-docs) (Swagger) estará disponível, assim como os [Testes](#tests) poderão ser executados.

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="api-docs"></a>
### 📰  Documentação da API

####  <img src="./docs/assets/images/icons/swagger.svg" width="20px" height="20px" alt="Swagger" title="Swagger">  Swagger

Com a aplicação em execução, a rota de documentação Swagger fica disponível em http://localhost:8080/swagger/index.html

<div align="center">
    <img src="./docs/assets/images/screen_captures/swagger.png">
</div>

A interface do Swagger pode executar [Validação Manual](#test-manual) a partir de `requests` no endpoint `POST: /payment` 

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="tests"></a>
### ✅ Testes Unitários & Integração

<a id="test-containerized"></a>

#### 🐋 Containerizado 
_Recomendado_

Para [Executar os Testes](#test-auto) usando container, é necessário que já esteja [Rodando o Projeto Containerizado](#run-containerized).

As configurações para executar os testes de repositório e integração (dependentes de infraestrutura) de maneira _containerizada_ estão no arquivo `./payments-api/.env.TEST`. Não é necessário alterá-lo ou renomeá-lo, pois a API o usará automaticamente se a variável de ambiente `ENV` estiver definida como `test`.

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

<a id="test-locally"></a>

#### 🏠 Local
_Apenas se necessário_

Para [Executar os Testes](#test-auto) com a API fora do container, de maneira _local_, é necessário editar seu `/.env.TEST`.

No arquivo `/.env.TEST`, substitua os valores das variáveis de ambiente que contêm comentários no formato `local: valueA | containerized: valueB` pelos valores sugeridos na opção `local`.
```bash
DATABASE_HOST=localhost         ### local: localhost | conteinerized: test-postgres
DATABASE_PORT=5433              ### local: 5433      | conteinerized: 5432

PUBSUB_HOST=localhost           ### local: localhost | conteinerized: redis
IN_MEMORY_LOCK_HOST=localhost   ### local: localhost | conteinerized: redis
IN_MEMORY_CACHE_HOST=localhost  ### local: localhost | conteinerized: redis

GRPC_SERVER_HOST=localhost      ### local: localhost | conteinerized: transaction-processor
GRPC_CLIENT_HOST=localhost      ### local: localhost | conteinerized: transaction-processor
```

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

<a id="test-auto"></a>
#### ⚙️ Executando Testes

[Rodando o Projeto](#run) `payment-api`  em seu ambiente _local_ ou _containerizado_, levante o banco de testes com

```bash
# Rodar o PostgreSQL de Testes
docker compose up test-postgres -d
```

Comando para executar o teste _containerizado_ com a API levantada __(Recomendado)__
```bash
# Executa Testes no Docker com ENV test (PostgreSQL de Testes na Integração)
docker compose exec -e ENV=test transaction-rest go test -v -count=1 ./internal/adapter/repository/gormRepos ./internal/adapter/repository/redisRepos ./internal/core/service ./internal/adapter/http/router
```

Comando para executar o teste _local_ em `payments-api` __(Apenas se necessário)__
```bash
# Executa Testes Localmente com ENV test (PostgreSQL de Testes na Integração)
ENV=test go test -v -count=1  ./internal/adapter/repository/gormRepos ./internal/adapter/repository/redisRepos ./internal/core/service ./internal/adapter/http/router
```

<details>
  <summary><b>Saída esperada do comando</b></summary>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/tests_run.png">
    </div>
</details>

<br/>

Cada vez que o comando for executado, as tabelas e índices da base de dados testada serão truncados e recriados no banco de dados do ambiente selecionado garantindo uma execução segura e limpa.

Os testes também são executados como parte da rotina minima de `CI` do <a href="https://github.com/jtonynet/go-payments-api/actions">GitHub Actions</a>, garantindo que versões estáveis sejam mescladas na branch principal. O badge `CI` no [cabeçalho](#header) do arquivo readme é uma ajuda visual para verificar rapidamente a integridade do desenvolvimento.

<details>
  <summary><b>Saída esperada do <u>workload</u> na fase test do <u>github</u></b></summary>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/githubactions_tests_run.png">
        <i>*Essa abordagem pode evoluir para uma rotina adequada de `CD`</i>
    </div>
</details>

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="test-load"></a>

### 🚚 Testes Carga & Performance

_Apenas Containerizado._

Atualmente o `Gatling` na versão 3.9.5 (desatualizada), realiza os testes de carga. Para executá-los, é necessário estar [Rodando o Projeto Containerizado](#run-containerized). Em outro terminal, no diretório raiz do projeto, execute os seguintes comandos

```bash
# Rodar o Gatling
docker compose up gatling -d
```

<br/>

```bash
# Executa o teste de carga 
docker exec -ti gatling /entrypoint run-test 
```

<details>
  <summary><b>Saída esperada do comando no <u>Terminal de Execução do Gatling</u></b></summary>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/load_test_gatling_terminal.png">
    </div>
</details>

<br/>

<details>
  <summary><b>Saída esperada nos terminais de <u>transaction-rest</u> e <u>transaction-processor</u></b></summary>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/load_test_performs_microservices.png">
    </div>
</details>

<br/>

<details>
  <summary><b>Saída esperada no client <u>Redis</u> de <u>cache-inmemory (db0)</u> e <u>lock-inmemory (db1)</u></b></summary>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/load_test_redis_client.png">
        <br/><i><a href="https://marketplace.visualstudio.com/items?itemName=Dunn.redis">*Usando Redis Dunn - VsCode Extension</a></i>
    </div>
</details>

<br/>

__Saída esperada no site [Gatling em seu localhost](http://localhost:9099)__
    <div align="center">
        <img src="./docs/assets/images/screen_captures/load_test_gatling_web.png">
    </div>
</details>

<br/>

O teste executa **7500k transações em 5 minutos** (ou `25 TPS`, `Transações Por Segundo`. Valor pico médio de tráfego de esperado pelo proponente do desafio, validado por benchmarks reais). O objetivo é validar o `timeoutSLA` de `100ms` em uma máquina local. Essa configuração pode ser encontrada nas seguintes linhas do arquivo [PaymentSimulation.scala](./tests/gatling/user-files/simulations/payments-api/PaymentSimulation.scala):

```scala
  private val tps = 25
  private val window = 5.minutes
  private val activeUsers = (window.toSeconds * tps).toInt
```

- __Picos de `TPS` sugeridos:__
    - __50, 100__ : Cenários de carga regular em ambientes controlados (máquina local).
    - __Acima de 100__: Considerados como `stress test` quando realizados em máquina local, devido à concorrência por recursos.
    - __200, 250, ...__: Cenários de carga avançada para validação de `homologação/produção`.
    - Em ambientes de `homologação/produção`, espera-se que o sistema suporte valores superiores a `250 TPS` (a validar).
    - Em ambientes de `homologação/produção`, a carga ofensora deve ser distribuída entre diferentes `pods`.

<br/>

O comando abaixo remove o histórico dos testes de carga.
```bash
# Limpa os dados do teste de carga 
docker exec -ti gatling /entrypoint clean-test 
```

<br/>

- __Considerações__
    - Os resultados variam conforme os processos e a configuração da máquina. Recomenda-se executar com poucas aplicações rodando e monitorar via `htop`.
    - Para fins de comparação, os testes mais antigos permanecem no diretório `tests/gatling/results/history/`.
    - Os resultados são apenas referência para o desenvolvimento local
    - Quando possível, valide em ambientes próximos à produção, eles tendem a ter perfomances superiores a máquina de desenvolvimento local.  

<br/>

- __Métricas Relevantes__ 
    - `Timeout`: tempo médio, mínimo e máximo de cada request.  
    - `Erros`: Use logs de debug para mapear serviços e identificar gargalos. (Utilize as ferramentas de [Observabilidade](#observability))
    
<br/>

- __Pré-produção e Stress Tests__
  - Nos ambientes de `pre-prod` e `stg`, se possível, use amostras maiores de dados próximos aos reais (`TPS`, `usuários médios` e `picos históricos`). Realize também `stress tests`, comprimindo cargas _(e.g., simular 30 minutos de tráfego em 10)_. Esses testes ajudam a identificar falhas e garantem a escalabilidade progressiva.

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="observability"></a>
### 🕵️ Observabilidade (Work In Progress)

_Apenas Containerizado. Validado no SO Ubunto 22_

<br/>

#### Ambiente & Stack:

Altere em seu arquivo `.env` as configurações de métricas do `database` para `true` e o `log_output` para `loki`.

```bash
DATABASE_METRICS_ENABLED=true
...
LOG_OPT_OUTPUT=loki                   ### text | json | loki
```

<br/>

Agora, [Rodando o Projeto](#run) `payment-api`  em seu ambiente _containerizado_ com seu `.env` configurado, suba as imagens necessárias com o comando abaixo e reinicie o `transaction-processor` e o `transaction-rest`.

```bash
# Rodar o pushgateway, redis-exporter, prometheus e grafana
docker compose up pushgateway redis-exporter prometheus loki promtail grafana -d
```

<br/>

<details>
  <summary><b>Saída esperada no site <a href="http://localhost:9090/">Prometheus em seu localhost</a></b></summary>
    <p>Rodando a consulta <i>gin_gonic_request_duration_bucket{path="/payment"}</i></p>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/prometheus.png">
    </div>
</details>

<br/>

Agora, acesse e configure o [Grafana em seu localhost](http://localhost:3000/)  (usr/pwd: admin/admin)

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

#### Configurando o Grafana:

A primeira vez que executarmos o Grafana, entramos com `usr/pwd` padrão de `admin/admin`. Ele solicita a alteração da senha, para facilitar o desenvolvimento local, alteramos para `admin/12345`.

<details>
  <summary><b>Criando conexão <u>Datasource com Prometheus</u></b></summary>
  <p>No menu lateral procure por <i>`Connections > Add New Connection`</i> digite <i>Prometheus</i> no campo de Search, selecione-o, clique em <i>`Add New Datasource`</i> e configure-o com a URL: <i>http://prometheus:9090</i> e clique no botão <i>`Save & test`</i> no final da página</p>
  <img src="./docs/assets/images/screen_captures/grafana_create_prometheus_conn.png">
</details>

<br/>

<details>
  <summary><b>Criando conexão <u>Datasource com Loki</u></b></summary>
  <p>Volte para <i>`Connections > Add New Connection`</i> e dessa vez digite <i>Loki</i> no campo de Search, selecione-o, clique em <i>`Add New Datasource`</i> e configure-o com a URL: <i>http://loki:3100</i> e clique no botão <i>`Save & test`</i> no final da página</p>
  <img src="./docs/assets/images/screen_captures/grafana_create_loki_conn.png">
</details>

<br/>

<details>
  <summary><b>Importando o <u>Dashboard RED / USE (wip)</u></b></summary>
  <p>Agora você pode usar o menu <i>`Dashboards > New > Import`</i> para importar o arquivo <b>dash-payments-api.json</b> que está localizado no diretório: <a href="./scripts/grafana-dashboards/">./scripts/grafana-dashboards</a>. Acesse o diretório em seu computador, clique e arraste o arquivo para o campo correto especificado pela tela <b>Upload Dashboard JSON File</b>, selecione o Prometheus previamente configurado como data source e proceda o import</p>
  <img src="./docs/assets/images/screen_captures/grafana_import_dashboard.png">
</details>

<br/>

<details>
  <summary><b>Vincule o <u>Dashboard</u> às conexões previamente criadas e acesse-o</b></summary>
  <img src="./docs/assets/images/screen_captures/grafana_import_dashboard_prometheus_loki_conn.png">
</details>

<br/>

<details>
  <summary><b>Importando o <u>Dashboard REDIS</u></b></summary>
  <p>Repita os passos de <b><i>Importando o <u>Dashboard RED / USE (wip)</u></i></b> de dashboard anteriores para o arquivo <i>dash-redis.json</i> atentando-se para o fato de que o `Redis` não consome dados do `Loki`</p>
  <img src="./docs/assets/images/screen_captures/grafana_redis.png"><br/><i>*Imagem retirada durante teste de carga. **Dashboard baixado da <a href="https://grafana.com/grafana/dashboards/763-redis-dashboard-for-prometheus-redis-exporter-1-x/">GrafanaLabs</a></i>
</details>

<br/>

<details>
  <summary><b>Consultando Logs no <u>Grafana Loki</u></b></summary>
  <p>Agora é possível utilizar o `Grafana` para filtrar seus logs de forma mais eficiente. Acesse o menu `Home > Connections > Data sources`, localize a lista de `sources` e, na linha correspondente ao `Loki`, clique no botão `Explore`. Isso abrirá a seção de consultas de logs, permitindo uma análise detalhada dos dados.</p>
  <p>Essa funcionalidade é especialmente poderosa quando utilizada em conjunto com os <a href="#test-load">Testes de Carga & Performance</a>, proporcionando insights valiosos para otimização e resolução de problemas ainda em desenvolvimento como visto abaixo em um exemplo de <i>Erro 07 por timeOut</i>.</p>
  <div align="center"><img src="./docs/assets/images/screen_captures/grafana_explore_loki_logs.png" alt="Tela de consulta de logs no Grafana Loki"></div>
</details>

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

#### Resultado Esperado:

Quando adequadamente importados, os `Dashboards` `REDIS` e `RED / USE (wip)` estarão disponíveis e responderão às solicitações que você pode simular pela [Documentação da API](#api-docs) ou pelos [Testes Carga & Performance](#test-load) (fortemente recomendado rodar em conjunto com a `Observabilidade`) bem como filtors de `logs` através do `Grafana Loki`.

<div align="center">
    <img src="./docs/assets/images/screen_captures/grafana_red.png">
    <i>*Imagem retirada durante teste de carga</i>
</div>

<br/>
 

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="test-manual"></a>
### 🧑‍🔧 Validação Manual

O banco de desenvolvimento local, quando adequadamente instalado, possui uma carga inicial de dados que pode ser utilizada para Validação Manual.

Registros e Saldos no banco para teste manual

`accounts`
> 
> | __Account:__                                            | __AcountID:__ |
> |---------------------------------------------------------|---------------|
> |123e4567-e89b-12d3-a456-426614174000                     | 1             |
>

<br/>

Query Consulta Balances (saldo mais recente de `transactions` por `categories` , não é a mesma da `repository`) por account:
```sql
SELECT 
	a.id as account_id, 
	a.uid as account_uid, 
	t.id as transaction_id, 
	t.uid as transaction_uid, 
	t.amount as amount, 
	c.id as category_id, 
	c.name as category_name, 
	c.priority as priority,
	STRING_AGG(mc.mcc, ',') AS codes
FROM 
	accounts as a 
JOIN 
	account_categories as ac ON ac.account_id = a.id 
JOIN 
	categories as c ON c.id = ac.category_id 
JOIN 
	transactions as t ON t.account_id = a.id  
	AND t.category_id = c.id 
	AND t.id = (
		SELECT MAX(t2.id) 
		FROM transactions t2 
		WHERE t2.account_id = a.id AND t2.category_id = c.id
	)
LEFT JOIN 
	mccs as mc ON mc.category_id = c.id 
WHERE 
	a.uid = '123e4567-e89b-12d3-a456-426614174000' 
GROUP BY a.id, a.uid, t.id, t.uid, t.amount, c.id, c.name, c.priority;
```

L1. L2. Resultado esperado:
> | __account_id__ | __account_uid__                      | __transaction_id__ | __transaction_uid__                  | __amount__ | category_id | category_name | priority | codes     |
> |----------------|--------------------------------------|--------------------|--------------------------------------|------------|-------------|---------------|----------|-----------|
> |1               | 123e4567-e89b-12d3-a456-426614174000 | 1                  | [NULL]                               | 1205.11    | 1           | FOOD          | 1        | 5411,5412 |
> |1               | 123e4567-e89b-12d3-a456-426614174000 | 2                  | [NULL]                               | 1110.22    | 2           | MEAL          | 2        | 5811,5812 |
> |1               | 123e4567-e89b-12d3-a456-426614174000 | 3                  | [NULL]                               | 1115.33    | 3           | MOBILITY      | 3        | 6411      |
> |1               | 123e4567-e89b-12d3-a456-426614174000 | 4                  | [NULL]                               | 1215.33    | 5           | CASH          | 5        |           |



_*Com acesso ao banco a partir dos dados de `.env`, para validar. Bem como a [Documentação da API](#api-docs) (Swagger) pode ser utilizado para proceder as `requests`._

<br/>

L3. `merchants` com mapeamentos MCC incorretos
>
> | __Merchant__                             | __MCCs__           | __Mapeado para Categoria__ |
> |------------------------------------------|--------------------|----------------------------|
> | UBER EATS                   SAO PAULO BR | 5412               | FOOD                       |
> | PAG*JoseDaSilva          RIO DE JANEI BR | 5812               | MEAL                       |
> <div align="center">...</div>

<br/>

_*Utilize o campo `name` real da tabela `merchant`, o github pode formatar de maneira incorreta esse dado no markdown._

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="diagrams"></a>
### 📊 Diagramas do Sistema
_*Diagramas Mermaid podem apresentar problemas de visualização em aplicativos mobile_

<!-- 
    diagrams by:
    https://mermaid.js.org/
-->

<a id="diagrams-erchart"></a>
#### 📈 ER

<div align="center">

```mermaid
erDiagram

    accounts_categories {
        int id PK
        int account_id FK
        int category_id FK
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }


    merchants {
        int id PK
        UUID uid
        string name
        int mcc_id FK
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }

    transactions {
        int id PK
        UUID uid
        int account_id FK
        int category_id FK
        numeric amount
        string mcc
        string merchant_name
        numeric total_amount
        timestamp created_at
        timestamp updated_at
        timestamp deleted_at
    }


   mccs {
        int id PK
        string mcc
        int category_id FK
        datetime created_at
        datetime updated_at
        timestamp deleted_at
    }


    categories {
        int id PK
        UUID uid
        string name
        int priority
        datetime created_at
        datetime updated_at
        timestamp deleted_at
    }
    
    accounts {
        int id PK
        UUID uid
        string name
        datetime created_at
        datetime updated_at
        timestamp deleted_at
    }

    transactions_latest {
        int account_id PK
        int category_id PK
        int transactions_latest_id
        numeric amount
    }

    categories ||--o{ transactions : has
    categories ||--o{ mccs : has
    categories ||--o{ accounts_categories : defines
    mccs ||--o{ merchants : has


    accounts_categories }o--|| accounts : has
    transactions }o--|| accounts : has

```

</div>

<a id="diagrams-erchart-description"></a>
##### 📝 Descrição

**accounts** Tabela principal, conectada a **transactions** e **accounts_categories**, armazenando informações sobre as contas.  
**accounts_categories** Vincula contas a categorias associadas.  
**categories** Armazena categorias (FOOD, MEAL, CASH...), com `priority` para definir a ordem de utilização.  
**mccs** Contém MCCs (códigos de quatro dígitos) associados às categorias.  
**merchants** Ajusta MCCs com base no nome do comerciante.
**transactions** Registra o histórico de transações realizadas, incluindo categoria, comerciante e valores.  
**transactions_latest**: Tabela auxiliar para reduzir o tempo de consulta às transações recentes das contas. Atualizada através da trigger `trg_update_latest_transaction`.

<br/>

<br/>
<div align="center">. . . . . . . . . . . . . . . . . . . . . . . . . . . .</div>
<br/>

<a id="diagrams-flowchart"></a>
#### 📈 Fluxo
__Autorização de Pagamento__

<!-- 
    diagram by:
    https://mermaid.js.org/
-->

<div align="center">

```mermaid
flowchart TD
    A([▶️<br/>Recebe Transação JSON]) --> B[Mapeia Categoria pelo nome do comerciante]
    B --> C[Buscar Saldos da Conta]
    C --> D{Saldo é suficiente <br/> na Categoria?}
    
    D -- Sim --> E[Debita Saldo da Categoria]
    D -- Não --> F{Saldo suficiente na <br/> Categoria e CASH?}
    
    F -- Sim --> G[Debita Categoria e CASH]
    F -- Não --> H{Saldo suficiente em CASH?}
    
    H -- Sim --> I[Debita Saldo de CASH]
    H -- Não --> J[Rejeita Transação com Código 51]
    
    E --> K[Registrar Transação Aprovada]
    G --> K[Registrar Transação Aprovada]
    I --> K[Registrar Transação Aprovada]
    
    K --> P{Ocorreu Erro no Processo da Transação?}
    P -- Sim --> Q[❌<br/><b>Rejeitada</b><br/> Retorna Código <b>07</b> por Falha Genérica</b>]
        P -- Não --> M[✅<br/><b>Aprovada</b><br/> Retorna Código <b>00</b>]
    
    J --> N[❌<br/><b>Rejeitada</b><br/> Retorna Código <b>51</b> por Saldo Insuficiente</b>]

    N --> O([⏹️<br/>Fim do Processo])
    M --> O
    Q --> O

    style M fill:#009933,stroke:#000
    style N fill:#cc0000,stroke:#000
    style Q fill:#cc0000,stroke:#000
```

</div>

_*Diagrama apresenta uma interpretação do sistema_


<a id="diagrams-flowchart-description"></a>
##### 📝 Descrição

1. **Recebe Transação JSON**: O sistema recebe o payload de transação.

2. **Mapeia MCC pelo Merchant Name**: Busca um relacionamento entre o `merchant` e uma categoria adequada. Caso categoria Não exista segue o fluxo para debitar de CASH

3. **Buscar Saldos da Conta**: A conta e os saldos (FOOD, MEAL, CASH) são buscados no banco de dados 

4. **Saldo é suficiente na Categoria?**: Verifica se o saldo disponível na categoria mapeada (com base no MCC) é suficiente.
    - Se sim, debita o saldo da categoria correspondente.
    - Se não, verifica o saldo de CASH.

5. **Saldo suficiente em CASH?**: Se a categoria principal não tiver saldo suficiente, o sistema verifica o saldo de CASH.
    - Se sim, debita parcial ou totalmente o saldo de CASH.
    - Se não, rejeita a transação com o código "51" (fundos insuficientes).

6. **Registrar Transação Aprovada**: A transação aprovada é registrada no banco de dados.

7. **Retorna Código "00"**: Se a transação foi aprovada, retorna o código "00" (aprovada).

8. **Retorna Código "51"**: Se a transação foi rejeitada por falta de fundos, retorna o código "51".

_*Esse fluxo representa o processo de aprovação, fallback e rejeição da transação com base nos saldos e MCC._

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="open-question"></a>
### 🅻 Questão Aberta L4


#### 🔒 Locks Distribuídos com Redis e Keyspace Notification

Com [`Locks Distribuídos`](https://redis.io/glossary/redis-lock/) e [`Bloqueio Pessimista`](https://martinfowler.com/eaaCatalog/pessimisticOfflineLock.html), o processamento por `account` é síncrono, mas operações distintas seguem simultâneas. O `Redis` gerencia `locks` para coordenar o acesso eficiente a recursos e o [`Redis Keyspace Notifications`](https://redis.io/docs/latest/develop/use/keyspace-notifications/), provê `unlocks` através de Pub/Sub. Consulte a `ADR` [0003: gRPC e Redis Keyspace Notification reduzindo Latência e evitando Concorrência](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-processor-para-reduzir-latencia-e-evitar-concorrencia.md) para maiores detalhes.

<!-- 
    diagram by:
    https://mermaid.js.org/
-->

<div align="center">

```mermaid
flowchart TD
    A([▶️<br/>Recebe Transação JSON]) --> B[Inicia Processamento de Transação]
    B --> C{Account da Transação está Bloqueado no <b>Lock Distribuído</b>?}
    
    C -- Não --> D[🔐<br/><b>Bloqueia</b><br/>Account da Transação no Lock Distribuído]
    D  --> E[[Processa Autorização de Pagamento]]

    C -- Sim --> M[✉️⬅️<br/><b>Subscreve</b><br/>Redis Keyspace Notification<br/><br/> ]
    M --> R[⏸️<br/><b>Aguarda</b><br> receber Mensagem de desbloqueio da Account do Redis Keyspace Notification]
    R --> N{Recebi Mensagem de desbloqueio em tempo útil? <br/> <b><i>t<i> < 100 ms</b>}
    N -- Sim --> D
    N -- Não --> O[❌<br/><b>Rejeitada</b><br/> Retorna Código <b>07</b> por Falha Genérica</b>]

    E --> F{Ocorreu Erro no Processo da Transação?}
    F -- Não --> G{Saldo é Suficiente?}
    F -- Sim --> K[❌<br/><b>Rejeitada</b><br/> Retorna Código <b>07</b> por Falha Genérica</b>]
    K --> J
    
    G -- Sim --> H[Atualiza Saldo e Registra Transação Aprovada]
    H --> I[✅<br/><b>Aprovada</b><br/> Retorna Código <b>00</b>]
    I --> J[🔓<br/><b>Desbloqueia</b><br/> Account da Transação no <br> Lock Distribuído]

    G -- Não --> L[❌<br/><b>Rejeitada</b><br/> Retorna Código <b>51</b> por Saldo Insuficiente</b>]
    L --> J

    J --> P[✉️➡️<br/><b>Publica</b><br/> mensagem de desbloqueio Redis Keyspace Notification]
    P --> Q([⏹️<br/>Fim do Processo])
    O --> Q

    style D fill:#78771b,stroke:#000
    style I fill:#009933,stroke:#000

    style L fill:#cc0000,stroke:#000
    style K fill:#cc0000,stroke:#000
    style O fill:#cc0000,stroke:#000

    style M fill:#007bff,stroke:#000
    style R fill:#007bff,stroke:#000

    style J fill:#78771b,stroke:#000
    style P fill:#007bff,stroke:#000
```

</div>

_*A etapa [`Processa Autorização de Pagamento`](#diagrams-flowchart) é uma sub-rotina do fluxo de Autorização, simplificada para sentido isolado. Detalhes do débito de saldos estão no fluxograma vinculado._

<!-- 
    diagram by:
    https://miro.com
-->
<details>
  <summary>O diagrama de fluxo acima foi produzido após uma sessão de <u>Miro Board</u> conduzida pelos proponentes do desafio. O diagrama Miro da proposta de arquitetura, resultado dessa sessão, pode ser visto <b><u>Aqui</u></b></summary>
    <div align="center">
        <img src="./docs/assets/images/screen_captures/miro/interview_architecture_proposal_v1.jpeg">
    </div>
A partir desse diagrama, construí uma segunda versão com poucas modificações, acrescentando detalhes e contexto para os que não estiveram presentes nessa sessão. Esse diagrama gerou o ADR <b><a href="./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-processor-para-reduzir-latencia-e-evitar-concorrencia.md">0003: gRPC e Redis Keyspace Notification reduzindo Latência e evitando Concorrência</a></b>, visando nortear a implementação do requisito L4 neste projeto, com finalidade estritamente de treinamento.

Via de regra, o que foi discutido naquela reunião deve ser implementado.
</details>

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="adr"></a> 
### 🧠 ADR - Architecture Decision Records

- [0001: Registro de Decisões de Arquitetura (ADR)](./docs/architecture/decisions/0001-registro-de-decisoes-de-arquitetura.md)
- [0002: Go, Gin, Gorm e PostgreSQL com Arquitetura Hexagonal e TDD](./docs/architecture/decisions/0002-go-gin-gorm-e-postgres-com-arquitetura-hexagonal-tdd.md)
- [0003: gRPC e Redis Keyspace Notification reduzindo Latência e evitando Concorrência](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-processor-para-reduzir-latencia-e-evitar-concorrencia.md)
- [0004: Banco Relacional Modelado Inspirado em Eventos](./docs/architecture/decisions/0004-banco-relacional-modelado-de-maneira-orientada-a-eventos.md)
- [0005: Estratégia de Testes de Carga e Performance com Cliente Sintético](./docs/architecture/decisions/0005-estrategia-de-testes-de-carga-e-performance-com-cliente-sintetico.md)
- [0006: Observabilidade com Prometheus e Grafana](./docs/architecture/decisions/0006-observabilidade-com-prometheus-e-grafana.md)
- [0007: Tabela Auxiliar para melhoria de Performance](./docs/architecture/decisions/0007-tabela-auxiliar-para-melhoria-de_performance.md)


<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="versions"></a>
### 🔢 Versões

As tags de versões estão sendo criadas manualmente a medida que o projeto avança com melhorias notáveis. Cada funcionalidade é desenvolvida em uma branch a parte (Branch Based, [feature branch](https://www.atlassian.com/git/tutorials/comparing-workflows/feature-branch-workflow)) quando finalizadas é gerada tag e mergeadas em master.

Para obter mais informações, consulte o [Histórico de Versões](./CHANGELOG.md).

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="tools"></a>
### 🧰 Ferramentas


- Linguagem:
  - [Go 1.23](https://go.dev/)
  - [GVM v1.0.22](https://github.com/moovweb/gvm)

- Framework & Libs:
  - [Gin](https://gin-gonic.com/)
  - [GORM](https://gorm.io/index.html)
  - [Viper](https://github.com/spf13/viper)
  - [Gin-Swagger](https://github.com/swaggo/gin-swagger)
  - [gjson](https://github.com/tidwall/gjson)
  - [uuid](github.com/google/uuid)
  - [gRPC](https://grpc.io/docs/languages/go/quickstart/)
  - [golang-migrate](https://github.com/golang-migrate/migrate)
  - [prometheus/promhttp](https://pkg.go.dev/github.com/prometheus/client_golang@v1.20.5/prometheus/promhttp)

- Infra & Tecnologias
  - [Docker v24.0.6](https://www.docker.com/)
  - [Docker compose v2.21.0](https://www.docker.com/)
  - [Postgres v16.0](https://www.postgresql.org/)
  - [Redis](https://redis.com/)
  - [Gatling](https://gatling.com/)
  - [prom/pushgateway](https://github.com/prometheus/pushgateway/blob/master/README.md)
  - [prom/redis-exporter](https://hub.docker.com/r/oliver006/redis_exporter)
  - [Prometheus](https://prometheus.io/)
  - [Grafana](https://grafana.com/)

- GUIs:
  - [DBeaver](https://dbeaver.io/)
  - [VsCode](https://code.visualstudio.com/)
    - [Redis Dunn - VsCode Extension](https://marketplace.visualstudio.com/items?itemName=Dunn.redis)
    - [gRPC Clicker - VsCode Extension](https://marketplace.visualstudio.com/items?itemName=Dancheg97.grpc-clicker)

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="best-practices"></a>
### 👏 Boas Práticas

- [Swagger](https://swagger.io/)
- [Github Project - Kanban](https://github.com/users/jtonynet/projects/7/views/1)
- [Semantic Versioning 2.0.0](https://semver.org/spec/v2.0.0.html)
- [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/)
- [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)
- [ADR - Architecture Decision Records](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions)
- [Mermaid Diagrams](https://mermaid.js.org)
- [Miro Diagrams](https://miro.com/)
- [Dockerized Load Testing Gatling](https://gatling.io/blog/load-testing-a-dockerized-application)
- [Observability Metrics RED with Gatling](https://grafana.com/)

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="ia"></a>
### 🤖 Uso de IA

A figura do cabeçalho nesta página foi criada com a ajuda de inteligência artificial e um mínimo de retoques e construção no Gimp [<img src="./docs/assets/images/icons/gimp.svg" width="30" height="30 " title="Gimp" alt="Gimp Logo" />](https://www.gimp.org/)

__Os seguintes prompts foram usados para criação no  [Bing IA:](https://www.bing.com/images/create/)__

<details>
  <summary><b>Gopher caixa de mercado</b></summary>
"gopher azul, simbolo da linguagem golang com um bone laranja, trabalhando como caixa de supermercado com algumas maquinhas de cartão de credito e cartões em cima da mesa, estilo cartoon, historia em quadrinhos, fundo branco chapado para facilitar remoção"<b>(sic)</b>
</details>

<br/>

IA também é utilizada em minhas pesquisas e estudos como ferramenta de apoio; no entanto,  __artes e desenvolvimento são, acima de tudo, atividades criativas humanas. Valorize as pessoas!__

Contrate artistas para projetos comerciais ou mais elaborados e aprenda a ser engenhoso!

<br/>

[⤴️ de volta ao índice](#index)

---

<br/>

<a id="conclusion"></a>
### 🏁 Conclusão

- Adotei o modelo hexagonal por sua flexibilidade com `ports` e `adapters`, permitindo suporte a `HTTP`, `gRPC` e fácil extensão para `Mensagens` ou `pub/sub` para atender ao requisito `L4`, sem impacto no `core` e com responsabilidades bem separadas.

- Para o `L4`, filas foram descartadas pelo proponente no `Miro Board` devido à latência. Detalhes no `ADR` [0003: gRPC e Redis Keyspace Notification](./docs/architecture/decisions/0003-grpc-e-redis-keyspace-notification-em-api-rest-e-processor-para-reduzir-latencia-e-evitar-concorrencia.md) e no `Kanban`.

- Refatoração das tabelas centralizou `transactions` e atualização de saldos por `categories`, garantindo `imutabilidade` e mitigando inconsistências. Detalhes no `ADR` [0004: Banco Relacional Modelado Inspirado em Eventos](./docs/architecture/decisions/0004-banco-relacional-modelado-de-maneira-orientada-a-eventos.md).

- Testes de performance com `Gatling` foram criados para garantir implantações seguras. Detalhes no `ADR` [0005: Estratégia de Testes de Carga e Performance com Cliente Sintético](./docs/architecture/decisions/0005-estrategia-de-testes-de-carga-e-performance-com-cliente-sintetico.md).  

- Adicionada `Observabilidade Métricas RED` usando `Prometheus` e `Grafana`. Essas ferramentas também são úteis no desenvolvimento, quando usadas em conjunto aos testes de `Performance` e `Carga` citadas anteriormente. Detalhes no `ADR` [0006: Observabilidade com Prometheus e Grafana](./docs/architecture/decisions/0006-observabilidade-com-prometheus-e-grafana.md). 

- Os números de métricas entre os testes do `Gatling` e do `Grafana` (WIP) estão descolados (não de maneira muito significativa). É necessário maior investigação para entender os motivos. Também é esperado que, ao se adotar o `Cliente Sintético` `K6`, pertencente ao ecossistema `Grafana`, esse descolamento deixe de ocorrer.

- Teste de stress abaixo foi realizado em um [Notebook ROG Strix G16 - 13ª Geração](https://br.store.asus.com/notebook-gamer-rog-strix-g16-13-geracao.html?config=90NR0D41-M00Y60) após melhorias no banco e consultas para `Performance`. Os resultados podem variar dependendo das configurações e processos abertos na máquina de desenvolvimento. Detalhes no `ADR` [0007: Tabela Auxiliar para Melhoria de Performance](./docs/architecture/decisions/0007-tabela-auxiliar-para-melhoria-de_performance.md). <div align="center"><img src="./docs/assets/images/screen_captures/improvement/load_test_400_tps_after_improvement.jpeg"></div>

- O requisito `L4` foi aprimorado em sua `Concorrência` com o `Refactor` do `adapter` de `PubSub` `Redis` e do `repository` de `memoryLock`. A instância da aplicação sobrescreve no `PubSub` uma única vez e distribui as mensagens de desbloqueio apenas para as `requests` bloqueadas, através de `channels` com `bufferSize` de `1`, armazenados em um `syncMap` com chave `accountUID`. Esse map, por sua vez, armazena os `channels` de `subscriptions` em um outro `syncMap` cujas chaves são `transactionUID`, tornando cada requisição única e eliminando conexões custosas com o `Redis`. Com isso, espera-se validar a hipótese de que múltiplas instâncias são capazes de gerenciar os recursos de forma mais eficiente, resultando no aumento do `TPS` atendido.

```go
// Exemplo ilustrativo de estrutura sync.Map usada no sistema para gerenciar concorrência
subscriptions := sync.Map{}

// Criando um sync.Map para "account1"
account1Transactions := &sync.Map{}
account1Transactions.Store("transaction1", make(chan string, 1))
account1Transactions.Store("transaction2", make(chan string, 1))
subscriptions.Store("account1", account1Transactions)

// Criando um sync.Map para "account2"
account2Transactions := &sync.Map{}
account2Transactions.Store("transaction3", make(chan string, 1))
subscriptions.Store("account2", account2Transactions)
```

- Aprimoramentos na `Observabilidade` com painéis de monitoramento `Grafana` do `Redis` `PubSub` e `Cache` fazem-se necessários, bem como melhorias na criação e no gerenciamento de `Logs` (`Grafana Loki`) e `Traces` baseados em `OpenTelemetry` com `Jaeger`. Esses aprimoramentos devem ser considerados no futuro próximo.

- Aprimorar o `Disaster Recovery` e implementar `Gracefull Shutdown`

- Testes adicionais devem ser criados (Concorrência e múltiplos cenários de erros nas rotas e serviços).

Este desafio me permite consolidar conhecimentos e identificar pontos cegos para aprimoramento. Continuarei trabalhando para evoluir o projeto e expandir minhas habilidades.

<br/>

[⤴️ de volta ao índice](#index)

---

<a id="footer"></a>

<br/>

>  _"Lifelong Learning & Prosper"_
> <br/> 
>  _Mr. Spock, maybe_   🖖🏾🚀

<div align="center">
    <a href="#footer">
        <img src="./docs/assets/images/layout/footer_learn_ingenuity_bg_hexagonal.png" />
    </a>
</div>

<!--
docker stop $(docker ps -aq)
docker rm $(docker ps -aq)
docker rmi $(docker images -q) --force
docker volume rm $(docker volume ls -q) --force
docker network prune -f
docker system prune -a --volumes

sudo systemctl restart docker
-->

<!--
gRPC WIP Commands:

```bash
cd payments-api/internal/core/port/proto/
```

```
protoc --go_out=./../../../adapter/gRPC/pb \
       --go_opt=paths=source_relative \
       --go-grpc_out=./../../../adapter/gRPC/pb \
       --go-grpc_opt=paths=source_relative \
       ./transaction.proto
```
-->

<!-- 
golang-migrate

https://github.com/golang-migrate/migrate/tree/master/cmd/migrate

curl -L https://packagecloud.io/golang-migrate/migrate/gpgkey | sudo apt-key add -
echo "deb https://packagecloud.io/golang-migrate/migrate/ubuntu/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/migrate.list
sudo apt-get update
sudo apt-get install -y migrate

migrate create -ext=sql -dir=payments-api/scripts/database/postgres/migrations init

migrate -source file://payments-api/scripts/database/postgres/migrations -database "postgres://api_user:api_pass@localhost:5432/payments_db?sslmode=disable" -verbose up 

docker compose exec postgres-payments psql -U api_user -d payments_db -f /seeds/load_test_charge.up.sql
-->
